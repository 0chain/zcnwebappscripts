#!/bin/bash

set -e
echo -e "\n\e[93m===============================================================================================================================================================================
                                                                Running scipt on DB
===============================================================================================================================================================================  \e[39m"
docker exec sharder-postgres-1 psql -U zchain_user -d events_db -c """UPDATE miners
SET total_stake = (
    SELECT SUM(balance) 
    FROM delegate_pools 
    WHERE status = 0 
    AND provider_id = miners.id
);"""

echo -e "\n\e[93m===============================================================================================================================================================================
                                                                Stopping sharder
===============================================================================================================================================================================  \e[39m"
docker stop sharder-1 sharder-postgres-1

echo -e "\n\e[93m===============================================================================================================================================================================
                                                                Updating postgres.conf file on your server
===============================================================================================================================================================================  \e[39m"
cd ~
wget -N https://github.com/0chain/zcnwebappscripts/raw/as-deploy/0chain/sharder-files/docker.local/config/postgresql.conf
cp -f postgresql.conf /var/0chain/sharder/ssd/docker.local/config/postgresql.conf

echo -e "\n\e[93m===============================================================================================================================================================================
                                                                Starting postgres and sharder
===============================================================================================================================================================================  \e[39m"
docker start sharder-postgres-1
sleep 5s
docker start sharder-1
